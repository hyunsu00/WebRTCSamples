<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC P2P Video Chat Example</title>
    <style>
        video { width: 300px; height: 225px; margin: 10px; background: #ddd; }
        textarea { width: 100%; height: 100px; }
        #logs { height: 200px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; }
    </style>
</head>
<body>
    <h1>WebRTC P2P Video Chat Example</h1>
    <div>
        <video id="localVideo" autoplay muted playsinline></video>
        <video id="remoteVideo" autoplay playsinline></video>
    </div>
    <div>
        <button id="startButton">Start Camera</button>
        <button id="callButton">Create Offer</button>
        <button id="answerButton">Create Answer</button>
    </div>
    <h3>Offer SDP:</h3>
    <textarea id="offerSdp" placeholder="Paste the received offer SDP here"></textarea>
    <h3>Answer SDP:</h3>
    <textarea id="answerSdp" placeholder="Paste the received answer SDP here"></textarea>
    <button id="setRemoteButton">Set Remote Description</button>
    <h3>Logs:</h3>
    <div id="logs"></div>

    <script>
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const startButton = document.getElementById('startButton');
        const callButton = document.getElementById('callButton');
        const answerButton = document.getElementById('answerButton');
        const setRemoteButton = document.getElementById('setRemoteButton');
        const offerSdpTextarea = document.getElementById('offerSdp');
        const answerSdpTextarea = document.getElementById('answerSdp');
        const logsDiv = document.getElementById('logs');

        let localStream;
        let remoteStream;
        let peerConnection;

        const configuration = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };

        function log(message) {
            console.log(message);
            logsDiv.innerHTML += message + '<br>';
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        startButton.onclick = startCamera;
        callButton.onclick = createOffer;
        answerButton.onclick = createAnswer;
        setRemoteButton.onclick = setRemoteDescription;

        async function startCamera() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                localVideo.srcObject = localStream;
                log('Local camera started');
            } catch (e) {
                log('Error accessing media devices: ' + e);
            }
        }

        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(configuration);
            log('PeerConnection created');

            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    log('New ICE candidate: ' + JSON.stringify(event.candidate));
                }
            };

            peerConnection.ontrack = event => {
                log('Received remote track');
                remoteVideo.srcObject = event.streams[0];
            };

            peerConnection.oniceconnectionstatechange = () => {
                log('ICE connection state: ' + peerConnection.iceConnectionState);
            };

            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
        }

        async function createOffer() {
            createPeerConnection();
            try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                offerSdpTextarea.value = JSON.stringify(offer);
                log('Offer created');
            } catch (e) {
                log('Error creating offer: ' + e);
            }
        }

        async function createAnswer() {
            createPeerConnection();
            try {
                const offer = JSON.parse(offerSdpTextarea.value);
                await peerConnection.setRemoteDescription(offer);
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                answerSdpTextarea.value = JSON.stringify(answer);
                log('Answer created');
            } catch (e) {
                log('Error creating answer: ' + e);
            }
        }

        async function setRemoteDescription() {
            try {
                const description = JSON.parse(answerSdpTextarea.value);
                await peerConnection.setRemoteDescription(description);
                log('Remote description set');
            } catch (e) {
                log('Error setting remote description: ' + e);
            }
        }
    </script>
</body>
</html>